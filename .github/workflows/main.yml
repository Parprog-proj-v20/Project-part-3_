name: MPI Rabbits CI

on:
  push:
    branches: [ "main", "devops" ]
  pull_request:
    branches: [ "main", "devops" ]
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install MPI dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake g++ libopenmpi-dev openmpi-bin
          
      - name: Build project
        run: |
          rm -rf build
          cmake -B build
          cmake --build build --parallel 4
          
      - name: Run main executable (with oversubscribe)
        run: |
          cd build
          echo "=== Running main executable (20 processes) ==="
          mpirun --oversubscribe -np 20 ./rabbits 2>&1 | tail -20 || echo "Program finished"
          
      - name: Run tests manually (with oversubscribe)
        run: |
          cd build
          echo "=== Running unit tests ==="
          
          # Запускаем каждый тест с oversubscribe
          for test_exec in tests/*; do
            if [ -f "$test_exec" ] && [ -x "$test_exec" ]; then
              test_name=$(basename "$test_exec")
              echo "Running $test_name..."
              
              # Запускаем с таймаутом и oversubscribe
              timeout 30s mpirun --oversubscribe -np 20 "$test_exec" 2>&1
              
              # Проверяем код возврата
              if [ $? -eq 0 ]; then
                echo "✓ $test_name passed"
              elif [ $? -eq 124 ]; then
                echo "⚠ $test_name timed out"
              else
                echo "✗ $test_name failed"
              fi
            fi
          done
          
      - name: Test wrong process count
        run: |
          cd build
          echo "=== Testing error handling ==="
          # Этот тест должен падать, и это нормально
          if mpirun --oversubscribe -np 10 ./rabbits 2>&1 | grep -q "Error: program must be run with 20 processes"; then
            echo "✓ System correctly detects wrong process count"
            exit 0  # Успех - мы ожидали ошибку
          else
            echo "✗ Failed to detect wrong process count"
            exit 1
          fi
